{{- if .Values.monitoring.enabled }}
{{- if .Values.monitoring.prometheusRules.enabled }}
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: esddns-operator
  namespace: {{ .Values.namespace.name }}
  labels:
    {{- include "esddns-operator.labels" . | nindent 4 }}
spec:
  groups:
  - name: esddns.rules
    interval: 30s
    rules:
    - alert: ESDDNSDNSUpdateFailures
      expr: increase(dns_update_failures_total[5m]) > 0
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "ESDDNS DNS updates failing"
        description: ESDDNS has had {{ "$value" }} DNS update failures in the last 5 minutes
    
    - alert: ESDDNSNoRecentUpdates
      expr: (time() - last_dns_update_timestamp) > 1200
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "ESDDNS has not updated DNS in 20+ minutes"
        description: "No DNS updates have been performed in the last 20+ minutes"
    
    - alert: ESDDNSOperatorDown
      expr: up{job="esddns-operator"} == 0
      for: 2m
      labels:
        severity: critical
      annotations:
        summary: "ESDDNS Operator is down"
        description: "ESDDNS Operator is not responding to health checks"
    
    - alert: ESDDNSServiceDown
      expr: up{job="esddns-service"} == 0
      for: 2m
      labels:
        severity: critical
      annotations:
        summary: "ESDDNS Service is down"
        description: "ESDDNS Service pod is not responding to health checks"
    
    - alert: ESDDNSLoadBalancerPending
      expr: kube_service_status_load_balancer_ingress{service="esddns-service"} == 0
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "ESDDNS LoadBalancer external IP not assigned"
        description: "The LoadBalancer service has not been assigned an external IP after 5 minutes"
{{- end }}
{{- end }}
